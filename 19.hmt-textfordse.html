<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMT Library Test - text_for_dserecord (Dynamic)</title>
    <style>
        body { font-family: sans-serif; line-height: 1.6; padding: 20px; }
        .status { font-weight: bold; }
        .error { color: red; }
        .success { color: green; }
        .test-case { border: 1px solid #ccc; padding: 15px; background-color: #f9f9f9; margin-top: 20px; }
        pre { background-color: #eef; padding: 10px; border-radius: 3px; white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto;}
        h3 { margin-top: 1em; }
    </style>
    <!-- 1. Include cex-lib.js -->
    <script src="https://cdn.jsdelivr.net/gh/neelsmith/cex-lib/cex.js"></script>
    <!-- 2. Include urn-lib.js -->
    <script src="https://cdn.jsdelivr.net/gh/neelsmith/urns-lib/urn-lib.js"></script>
    <!-- 3. Include your hmt-lib.js -->
    <script src="hmt-lib.js"></script>
</head>
<body>
    <h1>HMT Library Test: <code>text_for_dserecord</code> Function (Dynamic Tests)</h1>
    <div id="loadingStatus">
        <p class="status">Loading HMT CEX data and preparing tests... Please wait.</p>
    </div>

    <div id="testSummary">
        <!-- Summary will be populated here -->
    </div>

    <div id="testResultsContainer">
        <!-- Test results will be appended here -->
    </div>

    <div id="errorLog" style="display:none;" class="error"></div>

    <script>
        async function runDynamicTextForDseRecordTests() {
            const resultsContainer = document.getElementById('testResultsContainer');
            const errorLogDiv = document.getElementById('errorLog');
            const loadingStatusDiv = document.getElementById('loadingStatus');
            const testSummaryDiv = document.getElementById('testSummary');

            function showError(message, errorObj = null) {
                errorLogDiv.innerHTML += `<p>${message}</p>`;
                errorLogDiv.style.display = 'block';
                console.error(message, errorObj || '');
                loadingStatusDiv.innerHTML = `<p class="status error">An error occurred. Check console.</p>`;
            }
            
            function escapeHtml(unsafe) {
                if (unsafe === null || typeof unsafe === 'undefined') return 'null';
                return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
            }

            function displayDynamicTestResult(title, dseRecord, exemplarId, actualText) {
                const testCaseDiv = document.createElement('div');
                testCaseDiv.classList.add('test-case');
                
                let recordDetails = 'N/A';
                if (dseRecord && dseRecord.passage) {
                    recordDetails = `Passage URN: ${escapeHtml(dseRecord.passage)}`;
                }

                let resultHtml = `<h3>${escapeHtml(title)}</h3>`;
                resultHtml += `<p><strong>Input DSERecord:</strong> ${recordDetails}</p>`;
                resultHtml += `<p><strong>Exemplar ID Used:</strong> "${escapeHtml(exemplarId)}"</p>`;
                resultHtml += `<p><strong>Text Found:</strong></p><pre>${actualText ? escapeHtml(actualText) : "<em>No text found or empty string returned.</em>"}</pre>`;
                
                testCaseDiv.innerHTML = resultHtml;
                resultsContainer.appendChild(testCaseDiv);
            }

            // Check if HMTLib and necessary components are loaded
            if (typeof CEXParser === 'undefined' || typeof URNTools === 'undefined' || typeof HMTLib === 'undefined' ||
                !HMTLib.hmtcurrent || !HMTLib.hmtdse || !HMTLib.hmtnormalized || 
                !HMTLib.DSERecord || !HMTLib.text_for_dserecord) {
                showError("<strong>Error:</strong> A required library or HMTLib function (hmtcurrent, hmtdse, hmtnormalized, DSERecord, text_for_dserecord) is not defined. Ensure all scripts are loaded correctly.");
                loadingStatusDiv.innerHTML = `<p class="status error">HMTLib not fully loaded.</p>`;
                return;
            }
            
            try {
                loadingStatusDiv.innerHTML = `<p class="status">Loading current HMT release...</p>`;
                const parserInstance = await HMTLib.hmtcurrent();
                loadingStatusDiv.innerHTML = `<p class="status success">HMT CEX data loaded. Fetching DSE records and normalized corpus...</p>`;

                const allDseRecords = HMTLib.hmtdse(parserInstance);
                const normalizedTextLinesArray = HMTLib.hmtnormalized(parserInstance);
                const normalizedCorpusString = normalizedTextLinesArray.join("\n");

                if (allDseRecords.length === 0) {
                    testSummaryDiv.innerHTML = `<p class="error">No DSE records found in the HMT release. Cannot run dynamic tests.</p>`;
                    loadingStatusDiv.innerHTML = `<p class="status error">No DSE records for testing.</p>`;
                    return;
                }
                if (!normalizedCorpusString) {
                     console.warn("The normalized corpus string is empty. Text lookups might not find anything.");
                }


                testSummaryDiv.innerHTML = `
                    <p>Total DSE Records found: ${allDseRecords.length}</p>
                    <p>Normalized corpus lines loaded: ${normalizedTextLinesArray.length}</p>
                    <p>Testing with 5 random DSE records (or fewer if less than 5 available)...</p>
                `;

                // Select DSE Records at random
                const selectedDseRecords = [];
                const dseRecordsCopy = [...allDseRecords]; // Work on a copy
                const numToSelect = Math.min(5, dseRecordsCopy.length);

                for (let i = 0; i < numToSelect; i++) {
                    if (dseRecordsCopy.length === 0) break; // Should not happen if numToSelect is correct
                    const randomIndex = Math.floor(Math.random() * dseRecordsCopy.length);
                    selectedDseRecords.push(dseRecordsCopy.splice(randomIndex, 1)[0]);
                }

                loadingStatusDiv.innerHTML = `<p class="status">Running tests with ${selectedDseRecords.length} selected DSE records...</p>`;

                // Test with each randomly chosen record
                selectedDseRecords.forEach((dseRecord, index) => {
                    const exemplarIdToTest = "normalized";
                    let foundText = "";
                    try {
                        foundText = HMTLib.text_for_dserecord(dseRecord, exemplarIdToTest, normalizedCorpusString);
                    } catch (e) {
                        showError(`Error during text_for_dserecord call for DSE record (passage: ${dseRecord.passage}): ${e.message}`, e);
                        foundText = `ERROR: ${e.message}`;
                    }
                    displayDynamicTestResult(`Dynamic Test ${index + 1}`, dseRecord, exemplarIdToTest, foundText);
                });

                loadingStatusDiv.innerHTML = `<p class="status success">Dynamic tests complete. Check results below.</p>`;

            } catch (error) {
                showError(`<strong>Error during main test execution:</strong> ${error.message}`, error);
            }


            // --- Static Test Cases (Commented Out) ---
            /*
            function displayStaticTestResult(title, dseRecord, exemplarId, corpus, expected, actual) {
                const testCaseDiv = document.createElement('div');
                testCaseDiv.classList.add('test-case');
                let recordDetails = 'null';
                if (dseRecord && dseRecord.passage) {
                    recordDetails = `Passage: ${escapeHtml(dseRecord.passage)}`;
                }
                let resultHtml = `<h3>${escapeHtml(title)}</h3>`;
                resultHtml += `<p><strong>DSERecord:</strong> ${recordDetails}</p>`;
                resultHtml += `<p><strong>Exemplar ID:</strong> ${escapeHtml(exemplarId)}</p>`;
                resultHtml += `<p><strong>Corpus:</strong></p><pre>${escapeHtml(corpus)}</pre>`;
                resultHtml += `<p><strong>Expected Result:</strong></p><pre>${escapeHtml(expected)}</pre>`;
                resultHtml += `<p><strong>Actual Result:</strong></p><pre>${escapeHtml(actual)}</pre>`;
                resultHtml += `<p><strong>Status:</strong> <span class="${actual === expected ? 'success' : 'error'}">${actual === expected ? 'PASS' : 'FAIL'}</span></p>`;
                testCaseDiv.innerHTML = resultHtml;
                resultsContainer.appendChild(testCaseDiv);
            }

            const sampleCorpus = [
                "urn:cts:greekLit:tlg0012.tlg001.msA.normalized:1.1|Normalized Iliad 1.1 text.",
                // ... other static corpus lines
            ].join("\n");

            const dseIliad = new HMTLib.DSERecord("urn:cts:greekLit:tlg0012.tlg001.msA:1.1", "img:roi1", "surface:1r");
            // ... other static DSERecord instances

            // Test 1: Iliad - Normalized
            // let actual1 = HMTLib.text_for_dserecord(dseIliad, "normalized", sampleCorpus);
            // let expected1 = "Normalized Iliad 1.1 text.";
            // displayStaticTestResult("Test 1: Iliad - Normalized", dseIliad, "normalized", sampleCorpus, expected1, actual1);
            // ... other static test calls
            */
        }

        runDynamicTextForDseRecordTests();
    </script>
</body>
</html>